<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard</title>
    <link rel="stylesheet" href="assets/style/style.css">
</head>

<body>
    <header>
        <h1>Weather Dashboard</h1>
    </header>
    <div class="container">

        <main>
            <div class="city-display">
                <h2 class="name">City</h2>
                <p class="temp">Temperature: </p>
                <p class="humid">Humidity: </p>
                <p class="wind"> Wind Speed: </p>
                <p class="uv-index">UV Index:<span id="uv"></span></p>
            </div>
            <div class="five-day">
                <h3>5-day Forecast: </h3>
            </div>
        </main>
        <aside>
            <div class="search">
                <h3>Search for a City:</h3>
                <form id="city-form">
                    <input id="city-input" type="search" aria-label="Search">
                    <button id="search-btn" type="submit"><img id="search-icon"
                            src="assets/images/search-white-27x27.png"></button>
                </form>
            </div>
            <div class="button-list">
                <!-- City Buttons will be created here -->
            </div>

        </aside>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script type="text/javascript">
            // defining array in which city names will be stored, getting info from local storage
            var cities = [];
            // variable with Date() function to convert current date into (Month/Date/Year) format on page
            var date = ([new Date().getMonth() + 1] + "/" + [new Date().getDate()] + "/" + [new Date().getFullYear()]);

            $(document).ready(function () {
                    if (localStorage.getItem("Cities")) {
                        cities = JSON.parse(localStorage.getItem("Cities"));
                        var lastCity = cities.slice(-1);
                }
            // creating a function to display info for the city that was last searched for
            function renderLastCity () {
                var city = lastCity;
                var queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + city + "&appid=b406b96ea8ac39d55397323d0de502dd";
                
                $.ajax({
                        url: queryURL,
                        method: "GET"

                    }).then(function (response) {
                        // console.log(response);

                        // convert temperature Kelvin to Fahrenheit
                        var tempF = (response.main.temp - 273.15) * 1.80 + 32;
                        var icon = response.weather[0].icon;
                        var iconURL = "https://openweathermap.org/img/wn/" + icon + "@2x.png"
                        
                        // defining latitude and longitude to use for UV Index api call
                        // var uviLat = response.coord.lat;
                        // var uviLon = response.coord.lon;
                        var cityHtml = `
                            <section>
                                <h2>${response.name} (${date}) <img id="weather-icon" src="${iconURL}" alt="weather icon" height="52px" width="52px"></h2>
                                    <p>Temperature: ${tempF.toFixed(2)}&deg F</p>
                                    <p>Humidity: ${response.main.humidity}%</p>
                                    <p> Wind Speed: ${response.wind.speed} mph</p>
                            
                                `
                        $('.city-display').append(cityHtml);
                    });
           
            };
            renderLastCity();
            // function that will display buttons for cities user has searched for
            function renderButtons() {
                    $('.button-list').empty();
                    $('.city-display').empty();
                        // checking if any city info is present in local storage
                        // if so, parsing that info and creating buttons for each city 
                        if (localStorage.getItem("Cities")) {
                            cities = JSON.parse(localStorage.getItem("Cities"));

                            for (var i = 0; i < cities.length; i++) {   
                                var c = $("<button>");
                                c.addClass("city");
                                c.attr("data-name", cities[i]);
                                c.text(cities[i]);
                                $(".button-list").append(c);
                            }
                            
                            // console.log(lastCity);
                        }
                        // else {
                        //     var cities = [];
                        // }

                        // for loop was here ; going to try putting it inside if statement
                    // for (var i = 0; i < cities.length; i++) {
                    //     var c = $("<button>");
                    //     c.addClass("city");
                    //     c.attr("data-name", cities[i]);
                    //     c.text(cities[i]);
                    //     $(".button-list").append(c);
                    // }
                }
                renderButtons();
                // function to display the last searched city's info on the page
                
                

                // function to display a city's weather on the dashboard
                // includes ajax call and creating html elements with response data
                function displayCityInfo() {
                    $('.city-display').empty();
                    // trying val instead of data-name
                    // need if statement
                    
                    var city = $('#city-input').val();
                    if (city === ""){
                        city = $(this).attr("data-name");
                    }
                    // else if (city === undefined){
                    //     city = lastCity;
                    // }
                    console.log("City = " + city);
                    var queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + city + "&appid=b406b96ea8ac39d55397323d0de502dd";

                    // console.log(city);
                    // creates AJAX call for particular city button being clicked
                    $.ajax({
                        url: queryURL,
                        method: "GET"

                    }).then(function (response) {
                        console.log(response);

                        // convert temperature Kelvin to Fahrenheit
                        var tempF = (response.main.temp - 273.15) * 1.80 + 32;
                        var icon = response.weather[0].icon;
                        var iconURL = "https://openweathermap.org/img/wn/" + icon + "@2x.png"
                        
                        // defining latitude and longitude to use for UV Index api call
                        var uviLat = response.coord.lat;
                        var uviLon = response.coord.lon;
                        var cityHtml = `
                            <section>
                                <h2>${response.name} (${date}) <img id="weather-icon" src="${iconURL}" alt="weather icon" height="52px" width="52px"></h2>
                                    <p>Temperature: ${tempF.toFixed(2)}&deg F</p>
                                    <p>Humidity: ${response.main.humidity}%</p>
                                    <p> Wind Speed: ${response.wind.speed} mph</p>
                            
                                `
                        $('.city-display').append(cityHtml);

                        var uviURL = "http://api.openweathermap.org/data/2.5/uvi?lat=" + uviLat + "&lon=" + uviLon + "&appid=b406b96ea8ac39d55397323d0de502dd";
                        // make a separate function to call here rather than 
                        $.ajax({
                            url: uviURL,
                            method: "GET"

                        }).then(function(response) {
                            // console.log(response);
                            // getting uv index data
                            var uviData = response.value;
                            console.log(response.value);
                           
                            
                            if (Number(uviData) < 3) {
                                $('#uv').addClass("low");
                            }
                            else if (uviData >=3 && uviData < 6){
                                $('#uv').addClass("moderate");
                            }
                            else if (uviData >=6 && uviData < 8){
                                $('#uv').addClass("high");
                            }
                            else if (uviData >= 8 && uviData < 11){
                                $('#uv').addClass("very-high");
                            }
                            else if (uviData >= 11) {
                                $('#uv').addClass("extreme");
                            }
                            // continue for all colors in the UV spectrum...
                            
                            var cityUvHtml = `
                                <p>UV Index: <span id="uv">${uviData}</span></p> 
                            </section>
                        `
                        $('.city-display').append(cityUvHtml);

                            })  
                    })
                };
                
                // function displayFiveDayInfo() {
                //     $('.five-day').empty();
                
                //     var city = $(this).attr("data-name");

                //     var queryURL = "api.openweathermap.org/data/2.5/forecast?q=" + city + "&appid=b406b96ea8ac39d55397323d0de502dd"; 



                // }
                $('#search-btn').on("click", function (event) {
                    event.preventDefault();

                    // creating a variable named city, assigning text value to it
                    var city = $("#city-input").val().trim();
                    // was if (city !== null && city !== "")
                    if (city !== "" && cities.includes(city) === false) {
                        // logging city to console
                        console.log(city);

                        // add city currently in textbox to the array cities
                        cities.push(city);

                        localStorage.setItem("Cities", JSON.stringify(cities));
                        // calling renderButtons function so that all cities appear on the page
                        renderButtons();
                        // calling displayCityInfo function to display current weather for city user searched for
                        

                        // $("#city-form #city-input").val('');
                        displayCityInfo();
                    }
                    else {
                        alert("Please enter a new city name.");
                    }
                    // displayCityInfo() was down here, I moved it up into if statement
                    $("#city-form #city-input").val('');
                })

                $(document).on("click", ".city", displayCityInfo);

                // renderButtons();
            });
            // GIVEN a weather dashboard with form inputs
            // WHEN I search for a city
            // THEN I am presented with current and future conditions for that city and that city is added to the search history
            // WHEN I view current weather conditions for that city
            // THEN I am presented with the city name, the date, an icon representation of weather conditions, the temperature, the humidity, the wind speed, and the UV index
            // WHEN I view the UV index
            // THEN I am presented with a color that indicates whether the conditions are favorable, moderate, or severe
            // WHEN I view future weather conditions for that city
            // THEN I am presented with a 5-day forecast that displays the date, an icon representation of weather conditions, the temperature, and the humidity
            // WHEN I click on a city in the search history
            // THEN I am again presented with current and future conditions for that city
            // WHEN I open the weather dashboard
            // THEN I am presented with the last searched city forecast
        </script>
    </div>
</body>

</html>